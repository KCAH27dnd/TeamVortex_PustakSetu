window.NGO_DATA = {
  "Andhra Pradesh": [
            { name: "ADARSHA", address: "Vantavari Colony, Near R.T.C. Garage, Ongole" },
            { name: "Kothapet Mahila Mandali", address: "Pothuraju vari Chowk, Guntur" },
            { name: "Narasaraopet Taluka ST Youth Club", address: "Vinukonda Road, Narasaraopet-522601" },
            { name: "Valmiki Seva Sangham", address: "Chinnaganjam 523135, Prakasam Distt." }
          ],
          "Assam": [
            { name: "WODWICHEE", address: "P.O. Lakshirbond-788155, Hailakandi Distt." },
            { name: "Dhula Regional Association", address: "Distt. Darrang-784146" },
            { name: "South Borbond Gram Unnayan Samity", address: "District-Hailakandi-788164" }
          ],
          "Bihar": [
            { name: "Ekta Gram Seva Sansthan", address: "Veer Kunwar Singh Colony, Hajipur" },
            { name: "Sister Nivedita Memorial Trust", address: "New Jakkanpur, Patna" },
            { name: "Goduli Briddhashram", address: "Muzzafarnagar" }
          ],
          "Delhi": [
            { name: "Helpage India", address: "C-14, Qutab Institutional Area, New Delhi-16" },
            { name: "ANUGRAHA", address: "B-33, Arya Nagar Apts., IP Extension, Delhi-92" },
            { name: "Nari Utthan Samiti", address: "Maujpur, Delhi-92" }
          ],
          "Gujarat": [
            { name: "Sarvoday Seva Trust", address: "Mehsana Distt." },
            { name: "I Shree Khodiyar Education Trust", address: "Panch Mahal Distt." },
            { name: "Shri Sahajanand Kelavani Mandal", address: "Vadodara" }
          ],
          "Karnataka": [
            { name: "Adarsha Education Society", address: "Sanganakal, Bellary District" },
            { name: "Sri Uma Maheswara Mandira Trust", address: "Magadi Taluk, Bangalore Rural" },
            { name: "Sarvodaya Service Society", address: "Vijayapura, Bangalore Rural Distt." }
          ],
          "Maharashtra": [
            { name: "Jai Prakash Gram Kalyan Sanstha", address: "Gopal Nagar, Sangvi, Nanded" },
            { name: "Mahabodhi Education Society", address: "Mendha Road, Bhandara" },
            { name: "Bal Vikas Mahila Mandali", address: "Sudarshan Colony, Latur District" }
          ],
          "Manipur": [
            { name: "Centre for Rural Upliftment Services", address: "Wangbal, Thoubal-795135" },
            { name: "Community Development Association", address: "Palace Compound, Imphal-795001" }
          ],
          "Tamil Nadu": [
            { name: "Rural Education and Liberation Trust", address: "Plani Road, Dhrapuram" },
            { name: "Mass Welfare Association", address: "Anna Nagar, Cheyyar, 604407" },
            { name: "Bharathi Women Dev. Centre", address: "Thiruvarur Road, Thiruthuraipoondi" }
          ],
          "Uttar Pradesh": [
            { name: "Adarsh Kalyan Seva Samiti", address: "Mo. Joshiapura, Behraich District" },
            { name: "New Public School Samiti", address: "Tagore Marg, Daliganj, Lucknow" },
            { name: "Samaj Sewa Sansthan", address: "Sarai Mali Khan, Lucknow" }
          ],
          "Uttarakhand": [
            { name: "Ramaraj Gramin Vikash Kendra", address: "Govindpur, Haridwar-249401" },
            { name: "Gramya Mahila Kalyan Sansthan", address: "Prem Nagar, Dehradun-248007" },
            { name: "Jan Jagriti Seva Samiti", address: "Sitarganj, Udham Singh Nagar" }
          ],
          "Chhattisgarh": [
            { name: "Nav Abhilasha Shikshan Sansthan", address: "Dongargarh, Distt. Rajnandgaon" }
          ],
          "Haryana": [
            { name: "Amar Jyothi Foundation", address: "Julana, Jind District" },
            { name: "Adarsh Saraswati Shiksha Samiti", address: "Kakroi Road, Sonipat District" }
          ],
          "Himachal Pradesh": [
            { name: "Manav Kalyan Seva Samiti", address: "Tehsil - Chopal, District - Shimla" },
            { name: "Indira Ladies Club", address: "Nahan, Distt. Sirmour" }
          ],
          "Kerala": [
            { name: "Karuna Bhavan Social Centre", address: "Aluva (Via), Ernakula-683580" },
            { name: "Welfare Services Ernakulam", address: "Ponnurunni, Kochi-682019" }
          ],
          "Madhya Pradesh": [
            { name: "Mahila Utkarsh Sanstahn", address: "Vrindavan Colony, Indore-452006" },
            { name: "Indian Red Cross Society", address: "Jabalpur Distt." }
          ],
          "Odisha": [
            { name: "Jayakishan Youth Club", address: "PO: Gadasahi, Distt. Puri" },
            { name: "Arun Institute of Rural Affairs", address: "PO-Karamul, Distt. Dhenkanal" }
          ],
          "Telangana": [
            { name: "Anuraag Human Services", address: "Gudimalkapur, Hyderabad-500028" },
            { name: "Sai Seva Sangh", address: "Kukatpally, Hyderabad-500072" }
          ],
          "West Bengal": [
            { name: "All Bengal Women's Union", address: "89, Elliot Road, Kolkata 700016" },
            { name: "Janashiksha Prochar Kendra", address: "Baganda, District Hooghly" }
          ],
          "Mizoram": [
            { name: "Save Help and Develop (SHADE)", address: "Saron Veng, Aizawl-796007" }
          ],
          "Nagaland": [
            { name: "Good Samaritan Women Society", address: "Kohima, Nagaland" }
          ],
          "Punjab": [
            { name: "Bhai Ghanaiya Charitable Trust", address: "P.O. Urmar, Distt. Hoshiarpur" },
            { name: "Social Work & Rural Dev. Centre", address: "VPO-Nurpur Bedi, Distt. Ropar" }
          ],
          "Rajasthan": [
            { name: "Janvikas Sanchalan Samiti", address: "Alwar Distt., Rajasthan" },
            { name: "Ganga Vision", address: "Baran District-325205, Rajasthan" }
          ],
          "Tripura": [
            { name: "Abhoy Mission", address: "PO Ramnagar, Agartala-799002" },
            { name: "Sanghadip", address: "North Tripura" }
          ]
        };

/************************************
 * GLOBAL STATE CONTROL
 ************************************/





/************************************
 * AI IMAGE ANALYSIS
 ************************************/


/************************************
 * DONATE BOOK
 ************************************/


/************************************
 * REQUEST BOOK
 ************************************/
function submitRequest() {
  const userState = localStorage.getItem("userState");
if (!userState) {
    alert("Please enter your state first.");
    return;
  }

  const org = document.getElementById("org-name").value.trim();
  const loc = document.getElementById("location").value.trim();
  const book = document.getElementById("book-name").value.trim();
  const qty = document.getElementById("quantity").value;
  const pur = document.getElementById("purpose").value;

  if (!org || !loc || !book || !qty || !pur) {
    alert("Fill all fields");
    return;
  }
const donorEmail = "anonymous@donor.com";

  window.dbPush(window.dbRef(window.db, "requests"), {
    organization: org,
    location: loc,
    book,
    quantity: qty,
    purpose: pur,
    state: userState,
    donorEmail,
    createdAt: new Date().toISOString()
  });

  alert("Request submitted!");
}

/************************************
 * LOAD BOOKS (STATE AWARE)
 ************************************/
function loadBooks() {
  const grid = document.querySelector(".book-grid");
  if (!grid) return;

  window.dbRead(window.dbRef(window.db, "donations"), snap => {
    grid.innerHTML = "";

    if (!snap.exists()) {
      grid.innerHTML = "<p>No books available yet.</p>";
      return;
    }

    snap.forEach(child => {
      const d = child.val();

      // Optional: show only same state
      const userState = localStorage.getItem("userState");
if (userState && d.state !== userState) return;

      const card = document.createElement("div");
      card.className = "book-card";
      card.innerHTML = `
        <h3>${d.title}</h3>
        <p><strong>Author:</strong> ${d.author}</p>
        <p><strong>Category:</strong> ${d.category}</p>
        <p><strong>Condition:</strong> ${d.condition}</p>
        <p><strong>State:</strong> ${d.state}</p>
        <span class="status-badge available">${d.status}</span>
      `;
      grid.appendChild(card);
    });
  });
}


function continueToDonate() {
  const stateInput = document.getElementById("stateInput");

  const state = stateInput.value.trim();

  if (!state) {
    alert("Please enter your state to continue");
    return;
  }

  // unlock scrolling
  document.body.classList.remove("locked");

  // smooth scroll
  document.getElementById("donate").scrollIntoView({
    behavior: "smooth"
  });
}
// ===============================
// STATE HANDLING (MANDATORY)
// ===============================
function saveState() {
  const stateInput = document.getElementById("stateInput");
  const state = stateInput.value.trim();

  if (!state) {
    alert("Please enter your state to continue");
    return;
  }

  localStorage.setItem("userState", state);
  alert(`State saved: ${state}`);
}

// Check if state exists
function getUserState() {
  return localStorage.getItem("userState");
}

// ===============================
// BUTTON HANDLERS
// ===============================
function handleDonateClick() {
  const state = getUserState();

  if (!state) {
    alert("Please enter your state before donating books.");
    return;
  }

  document
    .getElementById("donate")
    .scrollIntoView({ behavior: "smooth" });
}

function handleNgoClick() {
  const state = getUserState();

  if (!state) {
    alert("Please enter your state before finding books.");
    return;
  }

  // NGO goes to Browse / Request (NOT donate)
  document
    .getElementById("browse")
    .scrollIntoView({ behavior: "smooth" });
}



function submitDonation() {
  
  // Read inputs
  const title = document.getElementById("book-title").value.trim();
  const author = document.getElementById("book-author").value.trim();
  const category = document.getElementById("book-category").value.trim();
  const condition = document.getElementById("book-condition").value;
  const description = document.getElementById("book-description").value.trim();
  const donorEmail = document.getElementById("donor-email").value.trim();
const state = localStorage.getItem("userState") || "";

 
  // Basic validation
  if (!title || !donorEmail) {
    alert("‚ùó Book title and donor email are required");
    return;
  }

  // Firebase push
  window.dbPush(
    window.dbRef(window.db, "donations"),
    {
      title,
      author,
      category,
      condition,
      description,
      state,
      donorEmail,          // üîë IMPORTANT
      status: "Available",
      createdAt: new Date().toISOString()
    }
  )
  .then(() => {
    alert("‚úÖ Book donated successfully!");

    // Optional: clear form
    document.getElementById("book-title").value = "";
    document.getElementById("book-author").value = "";
    document.getElementById("book-category").value = "";
    document.getElementById("book-condition").value = "";
    document.getElementById("book-description").value = "";
    document.getElementById("donor-email").value = "";
  })
  .catch((error) => {
    console.error(error);
    alert("‚ùå Error while donating book");
  });
}
// ---------- STATE AUTOCOMPLETE (Choose NGO Page) ----------

const states = [
  "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh",
  "Goa","Gujarat","Haryana","Himachal Pradesh","Jharkhand",
  "Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur",
  "Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan",
  "Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh",
  "Uttarakhand","West Bengal"
];



// ---------- FILTER NGO CARDS ----------

let selectedNGO = null;

function renderNGOs(state) {
  const container = document.getElementById("ngo-list");
  const title = document.getElementById("ngo-title");

  if (!container || !title) return;

  container.innerHTML = "";
  title.textContent = `NGOs in ${state}`;

  const ngos = NGO_DATA[state];

  if (!ngos || ngos.length === 0) {
    container.innerHTML = `
      <p style="text-align:center; color:#666;">
        No NGOs listed for ${state} yet.
      </p>`;
    return;
  }

  ngos.forEach((ngo) => {
    const card = document.createElement("div");
    card.className = "ngo-card";

    card.innerHTML = `
      <h3>${ngo.name}</h3>
      <p class="loc">üìç ${ngo.address}</p>
      <p class="need">üìö ${ngo.books ?? "100"} books needed</p>

      <button class="select-btn">Select This NGO</button>
    `;

    const btn = card.querySelector("button");

    btn.addEventListener("click", () => {
      // Remove selection from all cards
      document.querySelectorAll(".ngo-card").forEach(c => {
        c.classList.remove("selected");
        c.querySelector("button").textContent = "Select This NGO";
        c.querySelector("button").className = "select-btn";
      });

      // Select current card
      card.classList.add("selected");
      btn.textContent = "‚úì Selected";
      btn.className = "selected-btn";

      // Save selected NGO
      selectedNGO = { ...ngo, state };
      localStorage.setItem("selectedNGO", JSON.stringify(selectedNGO));
    });

    container.appendChild(card);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  
// ===============================
// FADE-IN SECTIONS (IMPORTANT)
// ===============================
const observer = new IntersectionObserver(
  (entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
      }
    });
  },
  { threshold: 0.1 }
);

// Observe all sections
document.querySelectorAll(".section").forEach((section) => {
  observer.observe(section);
});
  // ===============================
  // ANALYZE BUTTON
  // ===============================
  const analyzeBtn = document.getElementById("analyzeBtn");
  const imageInput = document.getElementById("book-image");

  if (analyzeBtn && imageInput) {
    analyzeBtn.addEventListener("click", async () => {
      if (!imageInput.files.length) {
        alert("Please select an image first");
        return;
      }

      const formData = new FormData();
      formData.append("image", imageInput.files[0]);

      try {
        analyzeBtn.innerText = "Analyzing...";
        analyzeBtn.disabled = true;

        const response = await fetch("http://localhost:5000/analyze-book", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        if (!data.success) throw new Error();

        alert("AI Result:\n\n" + data.result);

      } catch (err) {
  console.error(err);
  alert("AI failed. Please enter details manually.");

  // enable manual typing (just UX clarity)
  document.getElementById("book-title").focus();
} finally {
        analyzeBtn.innerText = "Analyze with AI";
        analyzeBtn.disabled = false;
      }
    });
  }

  // ===============================
  // STATE INPUT ENABLE BUTTONS
  // ===============================
  const stateInput = document.getElementById("stateInput");
 const donateBtn = document.querySelector(".donate-btn");
  const ngoBtn = document.querySelector(".ngo-btn");

  if (stateInput && donateBtn && ngoBtn) {
    const updateButtons = () => {
      const hasState = !!localStorage.getItem("userState");
      donateBtn.disabled = !hasState;
      ngoBtn.disabled = !hasState;
    };

    updateButtons();
    stateInput.addEventListener("input", updateButtons);
  }

  // ===============================
  // NGO STATE SEARCH
  // ===============================
  const stateSearch = document.getElementById("state-search");
  const tabsOutput = document.getElementById("tabs-output");

  if (stateSearch && tabsOutput) {
    stateSearch.addEventListener("input", () => {
      const q = stateSearch.value.toLowerCase();
      tabsOutput.innerHTML = "";
      if (q.length < 2) return;

      states
        .filter(s => s.toLowerCase().startsWith(q))
        .forEach(state => {
          const tab = document.createElement("div");
          tab.className = "state-tab";
          tab.textContent = state;
          tab.onclick = () => {
            stateSearch.value = state;
            localStorage.setItem("userState", state);
            renderNGOs(state);
            tabsOutput.innerHTML = "";
          };
          tabsOutput.appendChild(tab);
        });
    });
  }

loadBooks();


});


